module System
  SOUNDFONT = ""
  SOUNDFONT_DIR = ""
  LOGO = "app_logo"
  DESCRIPTION = "An RGSS based engine derived from mkxp developed by Ancurio"
  def self.user_language
    @user_language
  end

  def self.platform
    NAME
  end

  def self.linux?
    FAMILY_NAME == "linux"
  end

  def self.windows?
    FAMILY_NAME == "windows"
  end
end

module Game
  INI_FILENAME = (Dir["*.ini"][0] || ".ini")
  DATA = {}
  DATA.default = ""
  RTP = []
  def self.setup_screen
    @setup_screen
  end

  def self.setup_screen=(bool)
    @setup_screen = bool
  end

  def self.normal_size?
    (WIDTH >= 320 and HEIGHT >= 240)
  end

  def self.change_size?
    (WIDTH != START_WIDTH or HEIGHT != START_HEIGHT)
  end

  def self.process_exe_name(list)
    4.times do |n|
      if File.exist?(EXE_NAME + list[n])
        return n
      end
    end
    return 0
  end

  def self.process_ini
    begin
      lines = File.readlines(INI_FILENAME)
    rescue => e
      puts e.class, e.message, e.backtrace
      return
    end
    lines.size.times do
      key, value = lines.shift.split("=")
      unless key and value
        next
      end
      value = value.chomp
      if key[/RTP/i] != nil
        if value.size > 1
          RTP << value
        end
      elsif key[/SoundFontWin/i] != nil
        if System.windows?
          System.const_set("SOUNDFONT", value)
        end
      elsif key[/SoundFontLnx/i] != nil
        if System.linux?
          System.const_set("SOUNDFONT", value)
        end
      elsif key[/SoundFontPathWin/i] != nil
        if System.windows?
          System.const_set("SOUNDFONT_DIR", value)
        end
      elsif key[/SoundFontPathLnx/i] != nil
        if System.linux?
          System.const_set("SOUNDFONT_DIR", value)
        end
      else
        DATA[key] = value
      end
    end
  end

  def self.set_basic_values
    DATA["Scripts"].sub!("\\", "/")
    const_set("SCRIPTS", DATA.delete("Scripts").to_s)
    const_set("TITLE", DATA.delete("Title").to_s)
    const_set("VERSION", DATA.delete("Version").to_s)
    const_set("AUTHOR", DATA.delete("Author").to_s)
    const_set("EXE_NAME", INI_FILENAME.split('.')[0].to_s)
    icon_name = DATA.delete("Icon").to_s
    icon_name = Dir[icon_name + "*"][0]
    unless FileInt.exist?(icon_name)
      icon_name = ""
    end
    const_set("ICON", icon_name)
    projects = [".rhproj", ".rxproj", ".rvproj", ".rvproj2"]
    encrypt_ext = [".rhc", ".rgssad", ".rgss2a", ".rgss3a"]
    makers = ["HiddenChest", "XP", "VX", "VX Ace"]
    debug = (DATA["Debug"][/true/i] != nil)
    n = process_exe_name(projects)
    if n == 0
      n = process_exe_name(encrypt_ext)
      debug = false
    end
    const_set("DEBUG", debug)
    const_set("ENCRYPTED_NAME", EXE_NAME + encrypt_ext[n])
    const_set("MAKER", makers[n])
    const_set("RGSS_VERSION", n)
    w = DATA.delete("Width").to_i
    h = DATA.delete("Height").to_i
    w = (w == 0 ? START_WIDTH : w)
    h = (h == 0 ? START_HEIGHT : h)
    const_set("WIDTH", w)
    const_set("HEIGHT", h)
    @setup_screen = (normal_size? and change_size?)
    full = (DATA["Fullscreen"][/true/i] != nil)
    const_set("FULLSCREEN", full)
    puts "RGSS Version:       #{n} (#{MAKER})"
    puts "Game Screen Size:   #{WIDTH}x#{HEIGHT}"
    puts "Enable Debug:       #{DEBUG}"
    puts "Trigger Fullscreen: #{FULLSCREEN}"
  end
  process_ini
  set_basic_values
  set_internal_values
end