module System
  LOGO = "app_logo"
  DESCRIPTION = "An RGSS based engine derived from mkxp developed by Ancurio"
  extend self
  attr_reader :user_language
  def platform
    NAME
  end

  def linux?
    FAMILY_NAME == "linux"
  end

  def windows?
    FAMILY_NAME == "windows"
  end
end

module Game
  INI_FILENAME = Dir["*.ini"][0] || ".ini"
  DATA = {}
  DATA.default = ""
  RTP = []
  extend self
  def process_exe_name(list)
    4.times do |n|
      if FileInt.exist?(EXE_NAME + list[n])
        return n
      end
    end
    return 0
  end

  def process_ini
    begin
      lines = File.readlines(INI_FILENAME)
    rescue => e
      puts e.class, e.message, e.backtrace
      return
    end
    lines.size.times do
      key, value = lines.shift.split("=")
      unless key and value
        next
      end
      value = value.chomp
      if key[/RTP/i] != nil
        if value.size > 1
          RTP << value
        end
      elsif key[/SoundFontWin/i] != nil
        if System.windows?
          System.const_set("SOUNDFONT", value)
        end
      elsif key[/SoundFontLnx/i] != nil
        if System.linux?
          System.const_set("SOUNDFONT", value)
        end
      elsif key[/SoundFontPathWin/i] != nil
        if System.windows?
          System.const_set("SOUNDFONT_DIR", value)
        end
      elsif key[/SoundFontPathLnx/i] != nil
        if System.linux?
          System.const_set("SOUNDFONT_DIR", value)
        end
      else
        DATA[key] = value
      end
    end
    DATA["Scripts"].sub!("\\", "/")
    const_set("SCRIPTS", DATA["Scripts"])
    const_set("TITLE", DATA["Title"])
    const_set("VERSION", DATA["Version"])
    const_set("EXE_NAME", INI_FILENAME.split('.')[0])
    projects = [".rhproj", ".rxproj", ".rvproj", ".rvproj2"]
    encrypt_ext = [".rhc", ".rgssad", ".rgss2a", ".rgss3a"]
    makers = ["HiddenChest", "XP", "VX", "VX Ace"]
    n = process_exe_name(projects)
    if n == 0
      n = process_exe_name(encrypt_ext)
    end
    const_set("ENCRYPTED_NAME", EXE_NAME + encrypt_ext[n])
    const_set("MAKER", makers[n])
    const_set("RGSS_VERSION", n)
    puts "RGSS Version: #{n} (#{MAKER})"
  end
  process_ini
  set_internal_values
end